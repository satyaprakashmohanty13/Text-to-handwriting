<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✍️ Text to Handwriting Converter</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for general text -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for body and form elements */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
        }
        .container {
            max-width: 900px; /* Max width for the main content area */
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .form-input, .form-select, .form-textarea {
            @apply mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm;
        }
        .btn-primary {
            @apply inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out;
        }
        .radio-group {
            @apply flex items-center space-x-4; /* Spacing for radio buttons */
        }
        .radio-label {
            @apply ml-2 block text-sm text-gray-900;
        }
        /* Loading spinner animation */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6366f1; /* Indigo color for spinner */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="container mx-auto bg-white p-6 sm:p-8 rounded-lg shadow-lg">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">✍️ Text to Handwriting Converter</h1>
        <p class="text-center text-gray-600 mb-8">
            Enter your text, upload a TrueType Font (.ttf) file (or choose from pre-installed ones),
            and convert it into a PDF document that looks like it's written in your own handwriting!
            You can also customize the size, color, and add an optional paper background.
            A preview image and a downloadable PDF will be generated.
        </p>

        <form id="handwritingForm" class="space-y-6">
            <div>
                <label for="textInput" class="form-label">Enter your text here:</label>
                <textarea id="textInput" name="textInput" rows="10" class="form-textarea" placeholder="Type or paste your text..." required></textarea>
            </div>

            <div>
                <label for="fontFile" class="form-label">Upload your .ttf font file (Overrides selected font):</label>
                <input type="file" id="fontFile" name="fontFile" accept=".ttf" class="form-input file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
            </div>

            <div>
                <label for="selectedFontName" class="form-label">Choose from pre-installed fonts:</label>
                <select id="selectedFontName" name="selectedFontName" class="form-select">
                    <option value="None">None</option>
                    <!-- Options for pre-installed fonts will be populated by JavaScript -->
                </select>
            </div>

            <div>
                <label for="fontSize" class="form-label">Handwriting Size: <span id="fontSizeValue">16</span>px</label>
                <input type="range" id="fontSize" name="fontSize" min="10" max="72" value="16" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>

            <div>
                <label class="form-label">Handwriting Color:</label>
                <div class="radio-group">
                    <label class="inline-flex items-center">
                        <input type="radio" name="fontColor" value="Black" class="form-radio text-indigo-600" checked>
                        <span class="radio-label">Black</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="fontColor" value="Blue" class="form-radio text-indigo-600">
                        <span class="radio-label">Blue</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="fontColor" value="Red" class="form-radio text-indigo-600">
                        <span class="radio-label">Red</span>
                    </label>
                </div>
            </div>

            <div>
                <label for="backgroundImage" class="form-label">Upload Paper Background (Optional):</label>
                <input type="file" id="backgroundImage" name="backgroundImage" accept="image/*" class="form-input file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
            </div>

            <button type="submit" class="btn-primary w-full flex items-center justify-center">
                <span id="submitText">Generate Handwriting</span>
                <div id="loadingSpinner" class="loading-spinner ml-2 hidden"></div>
            </button>
        </form>

        <div id="messageContainer" class="mt-6 p-4 rounded-md text-sm" style="display: none;"></div>

        <div id="outputSection" class="mt-8 border-t pt-8 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Results:</h2>
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-700 mb-2">Handwriting Preview:</h3>
                <img id="previewImage" src="" alt="Handwriting Preview" class="w-full h-auto rounded-md shadow-md border border-gray-200" style="max-height: 600px; object-fit: contain;">
            </div>
            <div>
                <h3 class="text-lg font-medium text-gray-700 mb-2">Download PDF:</h3>
                <a id="downloadPdfLink" href="#" download="handwriting.pdf" class="btn-primary bg-green-600 hover:bg-green-700">Download PDF</a>
            </div>
        </div>
    </div>

    <script>
        // Get references to DOM elements
        const form = document.getElementById('handwritingForm');
        const textInput = document.getElementById('textInput');
        const fontFile = document.getElementById('fontFile');
        const selectedFontName = document.getElementById('selectedFontName');
        const fontSize = document.getElementById('fontSize');
        const fontSizeValue = document.getElementById('fontSizeValue');
        const backgroundImage = document.getElementById('backgroundImage');
        const submitButton = form.querySelector('button[type="submit"]');
        const submitText = document.getElementById('submitText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const messageContainer = document.getElementById('messageContainer');
        const outputSection = document.getElementById('outputSection');
        const previewImage = document.getElementById('previewImage');
        const downloadPdfLink = document.getElementById('downloadPdfLink');

        // IMPORTANT: Replace this with the actual URL of your deployed Hugging Face Space backend.
        // Example: 'https://your-username-your-space-name.hf.space'
        const BACKEND_URL = 'https://YOUR_HF_SPACE_URL'; // <--- **UPDATE THIS LINE**

        // Update the displayed font size value as the slider is moved
        fontSize.addEventListener('input', () => {
            fontSizeValue.textContent = fontSize.value;
        });

        // Function to fetch available pre-installed fonts from the backend and populate the dropdown
        async function fetchFonts() {
            // Check if BACKEND_URL is still the placeholder
            if (BACKEND_URL === 'https://YOUR_HF_SPACE_URL') {
                showMessage('Please update the BACKEND_URL in the JavaScript code (index.html) with your actual Hugging Face Space URL.', 'error');
                return; // Stop execution if URL is not updated
            }

            try {
                const response = await fetch(`${BACKEND_URL}/fonts`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                selectedFontName.innerHTML = '<option value="None">None</option>'; // Reset dropdown, add 'None' option
                data.fonts.forEach(font => {
                    if (font !== "None") { // Avoid adding "None" twice
                        const option = document.createElement('option');
                        option.value = font;
                        option.textContent = font;
                        selectedFontName.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('Error fetching fonts:', error);
                showMessage('Error loading pre-installed fonts. Please ensure your backend is running and the BACKEND_URL is correct. Details: ' + error.message, 'error');
            }
        }

        // Function to display messages to the user (success, error, info)
        function showMessage(message, type = 'info') {
            messageContainer.textContent = message;
            messageContainer.style.display = 'block';
            // Apply Tailwind classes based on message type
            if (type === 'error') {
                messageContainer.className = 'mt-6 p-4 rounded-md text-sm bg-red-100 text-red-700';
            } else if (type === 'success') {
                messageContainer.className = 'mt-6 p-4 rounded-md text-sm bg-green-100 text-green-700';
            } else {
                messageContainer.className = 'mt-6 p-4 rounded-md text-sm bg-blue-100 text-blue-700';
            }
        }

        // Function to hide the message container
        function hideMessage() {
            messageContainer.style.display = 'none';
        }

        // Event listener for form submission
        form.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission behavior (page reload)
            hideMessage(); // Hide any previous messages
            outputSection.classList.add('hidden'); // Hide previous results section

            // Check if BACKEND_URL is still the placeholder before submitting
            if (BACKEND_URL === 'https://YOUR_HF_SPACE_URL') {
                showMessage('Please update the BACKEND_URL in the JavaScript code (index.html) with your actual Hugging Face Space URL.', 'error');
                return; // Stop submission
            }

            // Show loading state
            submitText.textContent = 'Generating...';
            loadingSpinner.classList.remove('hidden');
            submitButton.disabled = true; // Disable button to prevent multiple submissions

            // Create FormData object to send form data, including files
            const formData = new FormData();
            formData.append('text_input', textInput.value);
            formData.append('font_size', fontSize.value);
            formData.append('font_color', document.querySelector('input[name="fontColor"]:checked').value);

            // Append font file or selected font name based on user input
            if (fontFile.files.length > 0) {
                formData.append('font_file', fontFile.files[0]);
            } else {
                formData.append('selected_font_name', selectedFontName.value);
            }

            // Append background image if uploaded
            if (backgroundImage.files.length > 0) {
                formData.append('background_image', backgroundImage.files[0]);
            }

            try {
                // Send POST request to the backend API
                const response = await fetch(`${BACKEND_URL}/generate_handwriting`, {
                    method: 'POST',
                    body: formData, // FormData automatically sets Content-Type to multipart/form-data
                });

                if (!response.ok) {
                    // Parse error message from backend if response is not OK
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                // Parse the JSON response from the backend
                const result = await response.json();
                
                // Construct full URLs for the image and PDF using the backend URL
                const imageUrl = `${BACKEND_URL}${result.image_url}`;
                const pdfUrl = `${BACKEND_URL}${result.pdf_url}`;

                // Update the image preview and PDF download link
                previewImage.src = imageUrl;
                downloadPdfLink.href = pdfUrl;
                outputSection.classList.remove('hidden'); // Show the results section
                showMessage('Handwriting generated successfully!', 'success');

            } catch (error) {
                console.error('Error:', error);
                showMessage(`Error generating handwriting: ${error.message}. Please ensure your backend is running and the BACKEND_URL is correct.`, 'error');
            } finally {
                // Reset loading state and re-enable the button
                submitText.textContent = 'Generate Handwriting';
                loadingSpinner.classList.add('hidden');
                submitButton.disabled = false;
            }
        });

        // Initialize the application when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            fetchFonts(); // Fetch available fonts on startup
        });
    </script>
</body>
</html>
